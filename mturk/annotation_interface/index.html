<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Annotator Interface</title>

    <link rel="stylesheet" type="text/css"
          href="https://fonts.googleapis.com/css?family=Roboto">
    <!-- Bootstrap -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.4/css/selectize.bootstrap3.min.css" class="stylesheet">
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">


    <link rel="stylesheet" type="text/css" href="style.css">

    <!-- <script type="text/javascript" src="script.js" defer></script> -->
  </head>
  <body>
    <div class="container">
        <div class="jumbotron">
            <h1 class="text-center">Fine-Type Annotation Interface</h1>
        </div>
        <div id="instructions-header" class="section-header page-header"
             onclick="toggleMenu($(this), 'instructions')">
            <h2> <span class="glyphicon glyphicon-menu-down section-glyphicon"></span> Instructions</h2>
        </div>
        <div id="instructions" class="section-content collapsible-block open-block">
            <div>
                Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam voluptas, quaerat commodi minima ipsam eligendi atque eaque. Neque dolorum nulla voluptatum in, nemo magni sunt voluptate amet hic molestias aspernatur.
            </div>
        </div>

        <div id="document-header" class="section-header page-header"
             onclick="toggleMenu($(this), 'document')">
            <h2> <span class="glyphicon glyphicon-menu-down section-glyphicon"></span> Document</h2>
        </div>
        <div id="document" class="section-content collapsible-block open-block">
            <!-- <button id="load-doc" type="button" class="btn btn-default"
                    style="background-color: inherit" 
                    onclick="">Load document</button> -->
            <div id="doc-view" class="entities">

                <!-- <div class="list-group">
                    <div class="list-group-item" id="sentence-0">
                        <div class="row sentence-list-item sentence-wrapper">
                            <div class="col-xs-1"><span class="sentence-list-index">1</span></div>
                            <div class="col-xs-11 sentence-content">
                                <div>The <mark onclick="onMarkClick($(this))" data-entity="" ent-id="0">Oscars </mark>have paid tribute to <mark onclick="onMarkClick($(this))" data-entity="" ent-id="1">Carrie Fisher </mark>and <mark onclick="onMarkClick($(this))" data-entity="" ent-id="2">Debbie Reynolds</mark>, who both died at <mark onclick="onMarkClick($(this))" data-entity="" ent-id="3">the end of 2016</mark>.</div>
                            </div>
                        </div>
                    </div>
                </div> -->

            </div>
        </div>

    </div>

    <!-- Templates -->
    <template id="sentence-template">
        <div class="row sentence-list-item sentence-wrapper">
            <div class="col-xs-1">
                <span class="sentence-list-index"></span></div>
            <div class="col-xs-11 sentence-content"></div>
        </div>
        <div class="row annotaion-wrapper">
        </div>
    </template>

    <template id="type-list-item-template">
        <li class="btn btn-primary btn-outline" onclick="onTypeClick($(this))"></li>
    </template>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://fastcdn.org/Underscore.js/1.8.3/underscore-min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>



    <script type="text/javascript">

        function toggleTypeButton($btn) {
            if (!$btn.hasClass('disabled'))
                $btn.toggleClass('btn-primary btn-success selected');
        }

        function deSelectTypeButton($btn) {
            if ($btn.hasClass('selected'))
                toggleTypeButton($btn);
        }

        function selectTypeButton($btn) {
            if (!$btn.hasClass('selected'))
                toggleTypeButton($btn);
        }

        function onCoarseTypeClick($liCoarse) {
            toggleTypeButton($liCoarse);
            if (!$liCoarse.hasClass('selected')) {
                // if not selected, all the fine-types should also be de-selected
                $liCoarse.siblings('.level-2').each(function(index, liFine) {
                    deSelectTypeButton($(liFine)) });
            }
            else {
                // if this button has been selected, 
                // disable all types assoicated with all other coarse types
                var thisCol = $liCoarse.closest('div[class^=col-]')[0];
                $liCoarse.closest('.type-select-wrapper').find('div[class^=col-]').each(function(index, thatCol){
                    if (thisCol != thatCol) {
                        $(thatCol).find('li.btn').each(function(index, liBtn) {
                            deSelectTypeButton($(liBtn)) });
                    }
                });
            }
        }

        function onFineTypeClick($liFine) {
            toggleTypeButton($liFine);
            if ($liFine.hasClass('selected')) {
                // automatically select the coarse type;
                var $liCoarse = $liFine.siblings('.level-1');
                if (!$liCoarse.hasClass('selected'))
                    onCoarseTypeClick($liCoarse);
            }
        }

        function onTypeClick($li) {
            if ($li.hasClass('level-1'))
                onCoarseTypeClick($li);
            else if ($li.hasClass('level-2'))
                onFineTypeClick($li);
            else
                console.log('Neither coarse nor fine!!');
        }

        function toggleMenu($node, collapseId) {
            $('#' + collapseId).toggleClass('open-block');
            $node.find('.glyphicon').toggleClass('glyphicon-menu-down glyphicon-menu-up');
        }

        function getCoarseToFine(typeHier) {
            // given the type-hier as presented in figer_type_hier.json,
            // creates a dictionary from coarse types to all its fine-types
            var getCoarse = function(type) {
                while (typeHier.get(type)['parent'] != null)
                    type = typeHier.get(type)['parent'];
                return type;
            }
            coarseToFine = {};
            for (var [type, properties] of typeHier) {
                if (typeHier.has(type)) {
                    var coarse = getCoarse(type);
                    // add coarse type to dictionary
                    if (!coarseToFine[coarse])
                        coarseToFine[coarse] = []
                    // if this is a fine type add this to the coarse type list
                    if (typeHier.get(type)['parent'] != null)
                        coarseToFine[coarse].push(type)
                }
            }
            // sort the fine-types for each coarse type
            _.each(coarseToFine, function(fineTypes, coarseType) { fineTypes.sort() });
            return coarseToFine;
        }


        function loadFigerHier() {

            var httpRequest = new XMLHttpRequest();

            if (!httpRequest) {
              alert('Giving up :( Cannot create an XMLHTTP instance');
              return false;
            }

            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState === XMLHttpRequest.DONE) {
                    if (httpRequest.status === 200) {
                        var response = JSON.parse(httpRequest.responseText);
                        var typeHier = new Map();
                        for (var i = 0; i < response.length; i++)
                            typeHier.set(response[i][0], response[i][1]);
                        globalStore.typeHier = typeHier;
                        globalStore.coarseToFine = getCoarseToFine(typeHier);
                    } else {
                        alert('There was a problem with the figer-hier request.');
                    }
                }
            };
            httpRequest.open('GET', './figer_type_hier.json', false);
            httpRequest.send(null);

            console.log('XMLHttpRequest for figer-hier sent.');
        }


        function getSentenceHTMLElement(sentence) {
            // return string constructed with tokens and spaces in [start, end)
            function getTextFromSpanForTokenSpaces(tokenSpaces, start, end) {
                return tokenSpaces.slice(start, end).reduce(function(acc, tokenSpace) {
                    return acc + tokenSpace[0] + tokenSpace[1];
                }, "");
            }

            var wrapTextInMark = function(text, eIdx) {
                return ('<mark onclick="onMarkClick($(this))" data-entity="" ent-id=' + eIdx + ' >' + text + '</mark>')
            };

            // tuples of tokens, spaces ( => zip(tokens, spaces) )
            var tokenSpaces;
            if (sentence.spaces == undefined)
                tokenSpaces = _.map(sentence.tokens, function(t) { return [t, " "]; });
            else
                tokenSpaces = sentence.tokens.map(
                    function(t, i) { return [t, sentence.spaces[i]]; });

            // clojure
            var getTextFromSpan = function(start, end) {
                return getTextFromSpanForTokenSpaces(tokenSpaces, start, end);}

            var sentLen = tokenSpaces.length;
            var ents = sentence.ents;

            var sentNode = document.createElement('div');
            // now populate sentNode with sentence contents by iterating through ents
            if (ents.length == 0)
                sentNode.innerText = getTextFromSpan(0, sentLen);
            else {
                var sentInnerHTML = "";
                var lastEntEnd = 0;
                _.each(ents, function(ent, eIdx) {
                    // add text before the entity
                    sentInnerHTML += getTextFromSpan(lastEntEnd, ent.start);
                    sentInnerHTML += wrapTextInMark(getTextFromSpan(ent.start, ent.end), eIdx);
                    lastEntEnd = ent.end;
                });
                // add text after the last entity
                sentInnerHTML += getTextFromSpan(lastEntEnd, sentLen);
                sentNode.innerHTML = sentInnerHTML;
            }
            return sentNode;
        }


        function getDocHTMLNode(docJson) {
            // listItem template
            var sentTmpl = document.getElementById('sentence-template');
            var $group = $('<div>', {'class': 'list-group'});

            _.each(docJson['sentences'], function(sentence, sIdx) {
                var $sc = $(sentTmpl.content.cloneNode(true));
                $sc.find('div.sentence-content')
                    .append(getSentenceHTMLElement(sentence));
                $sc.find('span.sentence-list-index').text(parseInt(sIdx)+1)

                var $li = $('<div>', {'class': 'list-group-item'}).append($sc).attr('id', 'sentence-'+sIdx);
                $group.append($li);
            });
            return $group[0];
        }


        function renderDocInNode(docJson, node) {
            var docHtml = getDocHTMLNode(docJson);
            $(node).append(docHtml);
        }


        function getTypeOptionsHTMLNode(coarseToFine) {
            var $root = $($.parseHTML('<div class="type-select-wrapper" id="type-window"></div>'));
            var curColsCount = 0;
            var $row = $($.parseHTML('<div class="row type-row"></div>'));
            var liTmpl = document.getElementById('type-list-item-template');

            // sort 'em
            var coarseTypes = _.sortBy(_.keys(coarseToFine), function(t) {
                return -coarseToFine[t].length});

            _.each(coarseTypes, function(coarseType) {
                fineTypes = coarseToFine[coarseType];
                var numCols;
                if (fineTypes.length >= 7)
                    numCols = 6;
                else
                    numCols = 3;

                if (curColsCount + numCols > 12) {
                    $root.append($row);
                    $row = $($.parseHTML('<div class="row type-row"></div>'));
                    curColsCount %= 12;
                }
                curColsCount += numCols;

                var $col = $('<div>', {'class': `col-xs-${numCols} ${coarseType}-col`});
                // add coarse type
                var $li = $(liTmpl.content.cloneNode(true));
                $li.find('li.btn').attr('value', coarseType).addClass('level-1').text(coarseType.toUpperCase());
                $col.append($li);
                // add fine types
                _.each(fineTypes, function(fineType) {
                    var $li = $(liTmpl.content.cloneNode(true));
                $li.find('li.btn').attr('value', fineType).addClass('level-2').text(fineType.split('.').pop().toUpperCase());
                    $col.append($li);
                });
                $row.append($col);
                // console.log($col)
            });
            $root.append($row);

            return $root;
        }


        function addAnnotationsToTypeWindow($typeWindow, sIdx, eIdx) {
            // if there are any stored annotations for sIdx, eIdx, render them onto
            // type window
            var typeVals = globalStore.docAnnots[sIdx][eIdx].types;
            // clear annotations if any
            $typeWindow.find('li.btn').each( function(index, li) {
                var $li = $(li);
                if ($li.hasClass('selected'))
                    toggleTypeButton($li);
            });
            // console.log(`sIdx: ${sIdx}, eIdx: ${eIdx}, typeVals: ${typeVals}`);
            _.each(typeVals, function(val) {
                toggleTypeButton($typeWindow.find(`li[value="${val}"]`))
            });
        }

        function showTypeAnnotationWindow(sIdx, eIdx) {
            // a global state for where it's currently shown/hidden
            var prevsIdx, preveIdx, prevShown;
            prevShown = false;
            if (globalStore.typeWindowState == undefined) {
                // not shown till now
                var $typeWindow = getTypeOptionsHTMLNode(globalStore.coarseToFine);
                // store this for later use
                globalStore.$typeWindow = $typeWindow;
            }
            else {
                [prevsIdx, preveIdx, prevShown] = globalStore.typeWindowState;
            }
            $typeWindow = globalStore.$typeWindow;
            addAnnotationsToTypeWindow($typeWindow, sIdx, eIdx);

            if (prevsIdx != sIdx || !prevShown) {
                if (prevShown) {
                    console.log(prevShown);
                    hideTypeAnnotationWindow();
                }
                $('#sentence-' + sIdx).append($typeWindow);
                $typeWindow.slideDown(0);
            }
        }


        function hideTypeAnnotationWindow() {
            var $typeWindow = globalStore.$typeWindow;
            $typeWindow.slideUp(0);
            $typeWindow.remove();
        }


        function saveCurAnnotations() {
            var $typeWindow = globalStore.$typeWindow;
            if (globalStore.typeWindowState == undefined || $typeWindow[0] == undefined)
                return;
            var [sIdx, eIdx, shown] = globalStore.typeWindowState;
            // get types
            var selectedTypes = $typeWindow.find('li.btn.selected').map(function (index, li) {return li.getAttribute('value')});
            globalStore.docAnnots[sIdx][eIdx].types = selectedTypes;
        }


        function clearHiglightedMark() {
            // clears the highlight of the current highlighted mark
            if (globalStore.typeWindowState != undefined) {
                var [sIdx, eIdx, shown] = globalStore.typeWindowState;
                if (shown)
                    $(`div#sentence-${sIdx} mark[ent-id=${eIdx}]`).removeClass('selected')
            }
        }


        function onMarkClick($mark) {
            var eIdx = parseInt($mark.attr('ent-id'));
            var sIdx = parseInt($mark.closest('div.list-group-item').attr('id').split('-').pop());

            // if closing
            if ($mark.hasClass('selected')) {
                $mark.removeClass('selected');
                saveCurAnnotations();
                hideTypeAnnotationWindow();
                globalStore.typeWindowState = [sIdx, eIdx, false];
            }
            else {
                saveCurAnnotations();
                showTypeAnnotationWindow(sIdx, eIdx);
                $mark.addClass('selected');
                clearHiglightedMark();
                globalStore.typeWindowState = [sIdx, eIdx, true];
            }
        }


        function getAnnotationDataStructure(docJson) {
            var docAnnots = {};
            _.each(docJson['sentences'], function(sentence, sIdx) {
                if (sentence.ents.length > 0) {
                    docAnnots[sIdx] = {};
                    _.each(sentence.ents, function(ent, eIdx) {
                        docAnnots[sIdx][eIdx] = {'types': [], 'coref': undefined};
                    });
                }
            });
            return docAnnots;
        } 


        function loadDocument() {
            $.ajax({
                url: './sample_doc.json',
                dataType: 'json',
                success: function(data) {
                    // sort ents in each sentece by start
                    _.each(data['sentences'], function(sentence) {
                        sentence.ents.sort(function(e1, e2) {
                            return e1.start - e2.start});
                    });
                    // validate data and not load if incorrect
                    globalStore.docJson = data;
                    globalStore.docAnnots = getAnnotationDataStructure(data);
                    // render document
                    renderDocInNode(data, $('div#doc-view'));
                },
                error: function(data) {
                    globalStore.docJson = null;
                }
            });
        }


        var globalStore = {};
        $(document).ready( function() {
            loadFigerHier();
            loadDocument();
        });
    </script>

  </body>
</html>